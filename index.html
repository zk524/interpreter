<meta name="viewport" content="width=device-width, initial-scale=1.0">
<div id="proc">
    <div id="prog"></div>
</div>
<input id="file" type="file" />
<button id="sync" disabled>SYNC</button>
<button id="read" disabled>READ</button>
<button id="prov" disabled>PROV</button>
<button id="send" disabled>SEND</button>
<button id="kill" disabled>KILL</button>
<button id="load">LOAD</button>
<button id="test">TEST</button>

<textarea id="data" rows="24"></textarea>
<script type="module">
    document.head.append(Object.assign(document.createElement('style'), { textContent: `div,textarea{width:1024px;max-width:100%;margin:3px 0} #file{display:none} #prog{height:100%;width:0%;background-color:#0d0;transition: width 0.5s;} #proc{ width:100%;height:12px;max-width:1024px}` }))
    Object.assign(window, {
        worker: new Worker("./index.js", { type: "module" }),
        BTN: (a, b) => [a, b].forEach((a, i) => a.forEach(n => document.getElementById(n).disabled = !i)),
        DGA: (id, e, f) => typeof e === "string" ? document.getElementById(id).addEventListener(e, f) : document.getElementById(id).onclick = e,
        onProgress: (a) => document.getElementById('prog').style.width = Math.max(0, Math.min(100, a)) + '%'
    })

    DGA("test", () => {
        let a = 0
        const timer = setInterval(() => {
            a += 10
            if (a > 100) return clearInterval(timer)
            onProgress(a)
        }, 300)
    })

    worker.onmessage = function (e) {
        switch (e.data.type) {
            case "init":
                BTN([], ["sync", "read"])
                DGA("sync", () => {
                    BTN(["sync", "read", "prov", "send"], ["kill"])
                    worker.postMessage({ action: "sync" })
                })
                DGA("read", () => {
                    BTN([], ["prov", "kill"])
                    worker.postMessage({ action: "read" })
                })
                DGA("prov", () => {
                    BTN(["sync", "read", "prov", "send"], ["kill"])
                    worker.postMessage({ action: "prov" })
                })
                DGA("send", () => {
                    BTN(["sync", "read", "prov", "send"], ["kill"])
                    worker.postMessage({ action: "send", tx: document.getElementById("data").value })
                })
                DGA("kill", () => {
                    BTN(["sync", "read", "prov", "send", "kill"], [])
                    alert(`killed${worker.terminate() ?? ""}`)
                    worker = new Worker("./index.js", { type: "module" })
                })
                DGA("load", () => document.getElementById("file").click())
                DGA("file", "change", (e) => {
                    const [reader, file] = [new FileReader(), ...e.target.files]
                    if (!file) return
                    reader.onload = e => document.getElementById("data").value = Array.from(new Uint8Array(e.target.result)).map(x => x.toString(16).padStart(2, '0')).join('')
                    reader.readAsArrayBuffer(file)
                    BTN([], ["send"])
                })
                DGA("data", "input", function () {
                    document.getElementById("send").disabled = !this.value
                })
                break
            case "synced":
                BTN([], ["sync", "read", "prov"])
                alert(e.data.mesg)
                break
            case "read":
                alert(e.data.mesg)
                break
            case "prov":
                BTN([], ["send"])
                alert(`cost: ${e.data.mesg} ms`)
                document.getElementById("data").value = e.data.tx
                break
            case "sent":
                BTN(["send"], [])
                alert(e.data.mesg)
                document.getElementById("data").value = ""
                break
            case "mesg":
                alert(`${e.data.mesg}`)
                break
        }
    }
</script>